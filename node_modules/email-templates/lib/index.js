"use strict";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = require('fs');

const path = require('path');

const I18N = require('@ladjs/i18n');

const _ = require('lodash');

const consolidate = require('consolidate');

const debug = require('debug')('email-templates');

const getPaths = require('get-paths');

const htmlToText = require('html-to-text');

const is = require('@sindresorhus/is');

const juice = require('juice');

const nodemailer = require('nodemailer');

const pify = require('pify');

const previewEmail = require('preview-email'); // promise version of `juice.juiceResources`


const juiceResources = (html, options) => {
  return new Promise((resolve, reject) => {
    juice.juiceResources(html, options, (err, html) => {
      if (err) return reject(err);
      resolve(html);
    });
  });
};

const env = (process.env.NODE_ENV || 'development').toLowerCase();
const stat = pify(fs.stat);
const readFile = pify(fs.readFile);

class Email {
  constructor(config = {}) {
    debug('config passed %O', config); // 2.x backwards compatible support

    if (config.juiceOptions) {
      config.juiceResources = config.juiceOptions;
      delete config.juiceOptions;
    }

    if (config.disableJuice) {
      config.juice = false;
      delete config.disableJuice;
    }

    if (config.render) {
      config.customRender = true;
    }

    this.config = _.merge({
      views: {
        // directory where email templates reside
        root: path.resolve('emails'),
        options: {
          // default file extension for template
          extension: 'pug',
          map: {
            hbs: 'handlebars',
            njk: 'nunjucks'
          },
          engineSource: consolidate
        },
        // locals to pass to templates for rendering
        locals: {
          // turn on caching for non-development environments
          cache: !['development', 'test'].includes(env),
          // pretty is automatically set to `false` for subject/text
          pretty: true
        }
      },
      // <https://nodemailer.com/message/>
      message: {},
      send: !['development', 'test'].includes(env),
      preview: env === 'development',
      // <https://github.com/ladjs/i18n>
      // set to an object to configure and enable it
      i18n: false,
      // pass a custom render function if necessary
      render: this.render.bind(this),
      customRender: false,
      // force text-only rendering of template (disregards template folder)
      textOnly: false,
      // <https://github.com/werk85/node-html-to-text>
      htmlToText: {
        ignoreImage: true
      },
      subjectPrefix: false,
      // <https://github.com/Automattic/juice>
      juice: true,
      juiceResources: {
        preserveImportant: true,
        webResources: {
          relativeTo: path.resolve('build'),
          images: false
        }
      },
      // pass a transport configuration object or a transport instance
      // (e.g. an instance is created via `nodemailer.createTransport`)
      // <https://nodemailer.com/transports/>
      transport: {},
      // last locale field name (also used by @ladjs/i18n)
      lastLocaleField: 'last_locale'
    }, config); // override existing method

    this.render = this.config.render;
    if (!_.isFunction(this.config.transport.sendMail)) this.config.transport = nodemailer.createTransport(this.config.transport);
    debug('transformed config %O', this.config);
    this.juiceResources = this.juiceResources.bind(this);
    this.getTemplatePath = this.getTemplatePath.bind(this);
    this.templateExists = this.templateExists.bind(this);
    this.checkAndRender = this.checkAndRender.bind(this);
    this.render = this.render.bind(this);
    this.renderAll = this.renderAll.bind(this);
    this.send = this.send.bind(this);
  } // shorthand use of `juiceResources` with the config
  // (mainly for custom renders like from a database)


  juiceResources(html) {
    return juiceResources(html, this.config.juiceResources);
  } // a simple helper function that gets the actual file path for the template


  async getTemplatePath(template) {
    const [root, view] = path.isAbsolute(template) ? [path.dirname(template), path.basename(template)] : [this.config.views.root, template];
    const paths = await getPaths(root, view, this.config.views.options.extension);
    const filePath = path.resolve(root, paths.rel);
    return {
      filePath,
      paths
    };
  } // returns true or false if a template exists
  // (uses same look-up approach as `render` function)


  async templateExists(view) {
    try {
      const {
        filePath
      } = await this.getTemplatePath(view);
      const stats = await stat(filePath);
      if (!stats.isFile()) throw new Error(`${filePath} was not a file`);
      return true;
    } catch (err) {
      debug('templateExists', err);
      return false;
    }
  }

  async checkAndRender(type, template, locals) {
    const str = `${template}/${type}`;

    if (!this.config.customRender) {
      const exists = await this.templateExists(str);
      if (!exists) return;
    }

    return this.render(str, _objectSpread({}, locals, {}, type === 'html' ? {} : {
      pretty: false
    }));
  } // promise version of consolidate's render
  // inspired by koa-views and re-uses the same config
  // <https://github.com/queckezz/koa-views>


  async render(view, locals = {}) {
    const {
      map,
      engineSource
    } = this.config.views.options;
    const {
      filePath,
      paths
    } = await this.getTemplatePath(view);

    if (paths.ext === 'html' && !map) {
      const res = await readFile(filePath, 'utf8');
      return res;
    }

    const engineName = map && map[paths.ext] ? map[paths.ext] : paths.ext;
    const renderFn = engineSource[engineName];
    if (!engineName || !renderFn) throw new Error(`Engine not found for the ".${paths.ext}" file extension`);

    if (_.isObject(this.config.i18n)) {
      if (this.config.i18n.lastLocaleField && this.config.lastLocaleField && this.config.i18n.lastLocaleField !== this.config.lastLocaleField) throw new Error(`The 'lastLocaleField' (String) option for @ladjs/i18n and email-templates do not match, i18n value was ${this.config.i18n.lastLocaleField} and email-templates value was ${this.config.lastLocaleField}`);
      const i18n = new I18N(_objectSpread({}, this.config.i18n, {
        register: locals
      })); // support `locals.user.last_locale` (variable based name lastLocaleField)
      // (e.g. for <https://lad.js.org>)

      if (_.isObject(locals.user) && _.isString(locals.user[this.config.lastLocaleField])) locals.locale = locals.user[this.config.lastLocaleField];
      if (_.isString(locals.locale)) i18n.setLocale(locals.locale);
    }

    const res = await pify(renderFn)(filePath, locals); // transform the html with juice using remote paths
    // google now supports media queries
    // https://developers.google.com/gmail/design/reference/supported_css

    if (!this.config.juice) return res;
    const html = await this.juiceResources(res);
    return html;
  }

  async renderAll(template, locals = {}, nodemailerMessage = {}) {
    const message = _objectSpread({}, nodemailerMessage);

    if (template) {
      const [subject, html, text] = await Promise.all(['subject', 'html', 'text'].map(type => this.checkAndRender(type, template, locals)));
      if (subject) message.subject = subject.trim();
      if (html) message.html = html;
      if (text) message.text = text;
    }

    if (message.subject && this.config.subjectPrefix) message.subject = this.config.subjectPrefix + message.subject;
    if (this.config.htmlToText && message.html && !message.text) // we'd use nodemailer-html-to-text plugin
      // but we really don't need to support cid
      // <https://github.com/andris9/nodemailer-html-to-text>
      message.text = htmlToText.fromString(message.html, this.config.htmlToText); // if we only want a text-based version of the email

    if (this.config.textOnly) delete message.html; // if no subject, html, or text content exists then we should
    // throw an error that says at least one must be found
    // otherwise the email would be blank (defeats purpose of email-templates)

    if ((!is.string(message.subject) || is.emptyStringOrWhitespace(message.subject)) && (!is.string(message.text) || is.emptyStringOrWhitespace(message.text)) && (!is.string(message.html) || is.emptyStringOrWhitespace(message.html)) && _.isArray(message.attachments) && _.isEmpty(message.attachments)) throw new Error(`No content was passed for subject, html, text, nor attachments message props. Check that the files for the template "${template}" exist.`);
    return message;
  }

  async send(options = {}) {
    options = _objectSpread({
      template: '',
      message: {},
      locals: {}
    }, options);
    let {
      template,
      message,
      locals
    } = options;
    const attachments = message.attachments || this.config.message.attachments || [];
    message = _.defaultsDeep({}, _.omit(message, 'attachments'), _.omit(this.config.message, 'attachments'));
    locals = _.defaultsDeep({}, this.config.views.locals, locals);
    if (attachments) message.attachments = attachments;
    debug('template %s', template);
    debug('message %O', message);
    debug('locals (keys only): %O', Object.keys(locals)); // get all available templates

    const obj = await this.renderAll(template, locals, message); // assign the object variables over to the message

    Object.assign(message, obj);

    if (this.config.preview) {
      debug('using `preview-email` to preview email');
      if (_.isObject(this.config.preview)) await previewEmail(message, this.config.preview);else await previewEmail(message);
    }

    if (!this.config.send) {
      debug('send disabled so we are ensuring JSONTransport'); // <https://github.com/nodemailer/nodemailer/issues/798>
      // if (this.config.transport.name !== 'JSONTransport')

      this.config.transport = nodemailer.createTransport({
        jsonTransport: true
      });
    }

    const res = await this.config.transport.sendMail(message);
    debug('message sent');
    res.originalMessage = message;
    return res;
  }

}

module.exports = Email;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiSTE4TiIsIl8iLCJjb25zb2xpZGF0ZSIsImRlYnVnIiwiZ2V0UGF0aHMiLCJodG1sVG9UZXh0IiwiaXMiLCJqdWljZSIsIm5vZGVtYWlsZXIiLCJwaWZ5IiwicHJldmlld0VtYWlsIiwianVpY2VSZXNvdXJjZXMiLCJodG1sIiwib3B0aW9ucyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXJyIiwiZW52IiwicHJvY2VzcyIsIk5PREVfRU5WIiwidG9Mb3dlckNhc2UiLCJzdGF0IiwicmVhZEZpbGUiLCJFbWFpbCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwianVpY2VPcHRpb25zIiwiZGlzYWJsZUp1aWNlIiwicmVuZGVyIiwiY3VzdG9tUmVuZGVyIiwibWVyZ2UiLCJ2aWV3cyIsInJvb3QiLCJleHRlbnNpb24iLCJtYXAiLCJoYnMiLCJuamsiLCJlbmdpbmVTb3VyY2UiLCJsb2NhbHMiLCJjYWNoZSIsImluY2x1ZGVzIiwicHJldHR5IiwibWVzc2FnZSIsInNlbmQiLCJwcmV2aWV3IiwiaTE4biIsImJpbmQiLCJ0ZXh0T25seSIsImlnbm9yZUltYWdlIiwic3ViamVjdFByZWZpeCIsInByZXNlcnZlSW1wb3J0YW50Iiwid2ViUmVzb3VyY2VzIiwicmVsYXRpdmVUbyIsImltYWdlcyIsInRyYW5zcG9ydCIsImxhc3RMb2NhbGVGaWVsZCIsImlzRnVuY3Rpb24iLCJzZW5kTWFpbCIsImNyZWF0ZVRyYW5zcG9ydCIsImdldFRlbXBsYXRlUGF0aCIsInRlbXBsYXRlRXhpc3RzIiwiY2hlY2tBbmRSZW5kZXIiLCJyZW5kZXJBbGwiLCJ0ZW1wbGF0ZSIsInZpZXciLCJpc0Fic29sdXRlIiwiZGlybmFtZSIsImJhc2VuYW1lIiwicGF0aHMiLCJmaWxlUGF0aCIsInJlbCIsInN0YXRzIiwiaXNGaWxlIiwiRXJyb3IiLCJ0eXBlIiwic3RyIiwiZXhpc3RzIiwiZXh0IiwicmVzIiwiZW5naW5lTmFtZSIsInJlbmRlckZuIiwiaXNPYmplY3QiLCJyZWdpc3RlciIsInVzZXIiLCJpc1N0cmluZyIsImxvY2FsZSIsInNldExvY2FsZSIsIm5vZGVtYWlsZXJNZXNzYWdlIiwic3ViamVjdCIsInRleHQiLCJhbGwiLCJ0cmltIiwiZnJvbVN0cmluZyIsInN0cmluZyIsImVtcHR5U3RyaW5nT3JXaGl0ZXNwYWNlIiwiaXNBcnJheSIsImF0dGFjaG1lbnRzIiwiaXNFbXB0eSIsImRlZmF1bHRzRGVlcCIsIm9taXQiLCJPYmplY3QiLCJrZXlzIiwib2JqIiwiYXNzaWduIiwianNvblRyYW5zcG9ydCIsIm9yaWdpbmFsTWVzc2FnZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsTUFBTUEsRUFBRSxHQUFHQyxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1FLElBQUksR0FBR0YsT0FBTyxDQUFDLGFBQUQsQ0FBcEI7O0FBQ0EsTUFBTUcsQ0FBQyxHQUFHSCxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNSSxXQUFXLEdBQUdKLE9BQU8sQ0FBQyxhQUFELENBQTNCOztBQUNBLE1BQU1LLEtBQUssR0FBR0wsT0FBTyxDQUFDLE9BQUQsQ0FBUCxDQUFpQixpQkFBakIsQ0FBZDs7QUFDQSxNQUFNTSxRQUFRLEdBQUdOLE9BQU8sQ0FBQyxXQUFELENBQXhCOztBQUNBLE1BQU1PLFVBQVUsR0FBR1AsT0FBTyxDQUFDLGNBQUQsQ0FBMUI7O0FBQ0EsTUFBTVEsRUFBRSxHQUFHUixPQUFPLENBQUMsa0JBQUQsQ0FBbEI7O0FBQ0EsTUFBTVMsS0FBSyxHQUFHVCxPQUFPLENBQUMsT0FBRCxDQUFyQjs7QUFDQSxNQUFNVSxVQUFVLEdBQUdWLE9BQU8sQ0FBQyxZQUFELENBQTFCOztBQUNBLE1BQU1XLElBQUksR0FBR1gsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FB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LENBQVk2QixTQUFaLEdBQXdCL0MsVUFBVSxDQUFDbUQsZUFBWCxDQUEyQjtBQUNqRDhDLFFBQUFBLGFBQWEsRUFBRTtBQURrQyxPQUEzQixDQUF4QjtBQUdEOztBQUVELFVBQU0xQixHQUFHLEdBQUcsTUFBTSxLQUFLckQsTUFBTCxDQUFZNkIsU0FBWixDQUFzQkcsUUFBdEIsQ0FBK0JmLE9BQS9CLENBQWxCO0FBQ0F4QyxJQUFBQSxLQUFLLENBQUMsY0FBRCxDQUFMO0FBQ0E0RSxJQUFBQSxHQUFHLENBQUMyQixlQUFKLEdBQXNCL0QsT0FBdEI7QUFDQSxXQUFPb0MsR0FBUDtBQUNEOztBQW5TUzs7QUFzU1o0QixNQUFNLENBQUNDLE9BQVAsR0FBaUJwRixLQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBJMThOID0gcmVxdWlyZSgnQGxhZGpzL2kxOG4nKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGNvbnNvbGlkYXRlID0gcmVxdWlyZSgnY29uc29saWRhdGUnKTtcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnZW1haWwtdGVtcGxhdGVzJyk7XG5jb25zdCBnZXRQYXRocyA9IHJlcXVpcmUoJ2dldC1wYXRocycpO1xuY29uc3QgaHRtbFRvVGV4dCA9IHJlcXVpcmUoJ2h0bWwtdG8tdGV4dCcpO1xuY29uc3QgaXMgPSByZXF1aXJlKCdAc2luZHJlc29yaHVzL2lzJyk7XG5jb25zdCBqdWljZSA9IHJlcXVpcmUoJ2p1aWNlJyk7XG5jb25zdCBub2RlbWFpbGVyID0gcmVxdWlyZSgnbm9kZW1haWxlcicpO1xuY29uc3QgcGlmeSA9IHJlcXVpcmUoJ3BpZnknKTtcbmNvbnN0IHByZXZpZXdFbWFpbCA9IHJlcXVpcmUoJ3ByZXZpZXctZW1haWwnKTtcblxuLy8gcHJvbWlzZSB2ZXJzaW9uIG9mIGBqdWljZS5qdWljZVJlc291cmNlc2BcbmNvbnN0IGp1aWNlUmVzb3VyY2VzID0gKGh0bWwsIG9wdGlvbnMpID0+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBqdWljZS5qdWljZVJlc291cmNlcyhodG1sLCBvcHRpb25zLCAoZXJyLCBodG1sKSA9PiB7XG4gICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKGh0bWwpO1xuICAgIH0pO1xuICB9KTtcbn07XG5cbmNvbnN0IGVudiA9IChwcm9jZXNzLmVudi5OT0RFX0VOViB8fCAnZGV2ZWxvcG1lbnQnKS50b0xvd2VyQ2FzZSgpO1xuY29uc3Qgc3RhdCA9IHBpZnkoZnMuc3RhdCk7XG5jb25zdCByZWFkRmlsZSA9IHBpZnkoZnMucmVhZEZpbGUpO1xuXG5jbGFzcyBFbWFpbCB7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZyA9IHt9KSB7XG4gICAgZGVidWcoJ2NvbmZpZyBwYXNzZWQgJU8nLCBjb25maWcpO1xuXG4gICAgLy8gMi54IGJhY2t3YXJkcyBjb21wYXRpYmxlIHN1cHBvcnRcbiAgICBpZiAoY29uZmlnLmp1aWNlT3B0aW9ucykge1xuICAgICAgY29uZmlnLmp1aWNlUmVzb3VyY2VzID0gY29uZmlnLmp1aWNlT3B0aW9ucztcbiAgICAgIGRlbGV0ZSBjb25maWcuanVpY2VPcHRpb25zO1xuICAgIH1cblxuICAgIGlmIChjb25maWcuZGlzYWJsZUp1aWNlKSB7XG4gICAgICBjb25maWcuanVpY2UgPSBmYWxzZTtcbiAgICAgIGRlbGV0ZSBjb25maWcuZGlzYWJsZUp1aWNlO1xuICAgIH1cblxuICAgIGlmIChjb25maWcucmVuZGVyKSB7XG4gICAgICBjb25maWcuY3VzdG9tUmVuZGVyID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbmZpZyA9IF8ubWVyZ2UoXG4gICAgICB7XG4gICAgICAgIHZpZXdzOiB7XG4gICAgICAgICAgLy8gZGlyZWN0b3J5IHdoZXJlIGVtYWlsIHRlbXBsYXRlcyByZXNpZGVcbiAgICAgICAgICByb290OiBwYXRoLnJlc29sdmUoJ2VtYWlscycpLFxuICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIC8vIGRlZmF1bHQgZmlsZSBleHRlbnNpb24gZm9yIHRlbXBsYXRlXG4gICAgICAgICAgICBleHRlbnNpb246ICdwdWcnLFxuICAgICAgICAgICAgbWFwOiB7XG4gICAgICAgICAgICAgIGhiczogJ2hhbmRsZWJhcnMnLFxuICAgICAgICAgICAgICBuams6ICdudW5qdWNrcydcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbmdpbmVTb3VyY2U6IGNvbnNvbGlkYXRlXG4gICAgICAgICAgfSxcbiAgICAgICAgICAvLyBsb2NhbHMgdG8gcGFzcyB0byB0ZW1wbGF0ZXMgZm9yIHJlbmRlcmluZ1xuICAgICAgICAgIGxvY2Fsczoge1xuICAgICAgICAgICAgLy8gdHVybiBvbiBjYWNoaW5nIGZvciBub24tZGV2ZWxvcG1lbnQgZW52aXJvbm1lbnRzXG4gICAgICAgICAgICBjYWNoZTogIVsnZGV2ZWxvcG1lbnQnLCAndGVzdCddLmluY2x1ZGVzKGVudiksXG4gICAgICAgICAgICAvLyBwcmV0dHkgaXMgYXV0b21hdGljYWxseSBzZXQgdG8gYGZhbHNlYCBmb3Igc3ViamVjdC90ZXh0XG4gICAgICAgICAgICBwcmV0dHk6IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8vIDxodHRwczovL25vZGVtYWlsZXIuY29tL21lc3NhZ2UvPlxuICAgICAgICBtZXNzYWdlOiB7fSxcbiAgICAgICAgc2VuZDogIVsnZGV2ZWxvcG1lbnQnLCAndGVzdCddLmluY2x1ZGVzKGVudiksXG4gICAgICAgIHByZXZpZXc6IGVudiA9PT0gJ2RldmVsb3BtZW50JyxcbiAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9sYWRqcy9pMThuPlxuICAgICAgICAvLyBzZXQgdG8gYW4gb2JqZWN0IHRvIGNvbmZpZ3VyZSBhbmQgZW5hYmxlIGl0XG4gICAgICAgIGkxOG46IGZhbHNlLFxuICAgICAgICAvLyBwYXNzIGEgY3VzdG9tIHJlbmRlciBmdW5jdGlvbiBpZiBuZWNlc3NhcnlcbiAgICAgICAgcmVuZGVyOiB0aGlzLnJlbmRlci5iaW5kKHRoaXMpLFxuICAgICAgICBjdXN0b21SZW5kZXI6IGZhbHNlLFxuICAgICAgICAvLyBmb3JjZSB0ZXh0LW9ubHkgcmVuZGVyaW5nIG9mIHRlbXBsYXRlIChkaXNyZWdhcmRzIHRlbXBsYXRlIGZvbGRlcilcbiAgICAgICAgdGV4dE9ubHk6IGZhbHNlLFxuICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL3dlcms4NS9ub2RlLWh0bWwtdG8tdGV4dD5cbiAgICAgICAgaHRtbFRvVGV4dDoge1xuICAgICAgICAgIGlnbm9yZUltYWdlOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIHN1YmplY3RQcmVmaXg6IGZhbHNlLFxuICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL0F1dG9tYXR0aWMvanVpY2U+XG4gICAgICAgIGp1aWNlOiB0cnVlLFxuICAgICAgICBqdWljZVJlc291cmNlczoge1xuICAgICAgICAgIHByZXNlcnZlSW1wb3J0YW50OiB0cnVlLFxuICAgICAgICAgIHdlYlJlc291cmNlczoge1xuICAgICAgICAgICAgcmVsYXRpdmVUbzogcGF0aC5yZXNvbHZlKCdidWlsZCcpLFxuICAgICAgICAgICAgaW1hZ2VzOiBmYWxzZVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgLy8gcGFzcyBhIHRyYW5zcG9ydCBjb25maWd1cmF0aW9uIG9iamVjdCBvciBhIHRyYW5zcG9ydCBpbnN0YW5jZVxuICAgICAgICAvLyAoZS5nLiBhbiBpbnN0YW5jZSBpcyBjcmVhdGVkIHZpYSBgbm9kZW1haWxlci5jcmVhdGVUcmFuc3BvcnRgKVxuICAgICAgICAvLyA8aHR0cHM6Ly9ub2RlbWFpbGVyLmNvbS90cmFuc3BvcnRzLz5cbiAgICAgICAgdHJhbnNwb3J0OiB7fSxcbiAgICAgICAgLy8gbGFzdCBsb2NhbGUgZmllbGQgbmFtZSAoYWxzbyB1c2VkIGJ5IEBsYWRqcy9pMThuKVxuICAgICAgICBsYXN0TG9jYWxlRmllbGQ6ICdsYXN0X2xvY2FsZSdcbiAgICAgIH0sXG4gICAgICBjb25maWdcbiAgICApO1xuXG4gICAgLy8gb3ZlcnJpZGUgZXhpc3RpbmcgbWV0aG9kXG4gICAgdGhpcy5yZW5kZXIgPSB0aGlzLmNvbmZpZy5yZW5kZXI7XG5cbiAgICBpZiAoIV8uaXNGdW5jdGlvbih0aGlzLmNvbmZpZy50cmFuc3BvcnQuc2VuZE1haWwpKVxuICAgICAgdGhpcy5jb25maWcudHJhbnNwb3J0ID0gbm9kZW1haWxlci5jcmVhdGVUcmFuc3BvcnQodGhpcy5jb25maWcudHJhbnNwb3J0KTtcblxuICAgIGRlYnVnKCd0cmFuc2Zvcm1lZCBjb25maWcgJU8nLCB0aGlzLmNvbmZpZyk7XG5cbiAgICB0aGlzLmp1aWNlUmVzb3VyY2VzID0gdGhpcy5qdWljZVJlc291cmNlcy5iaW5kKHRoaXMpO1xuICAgIHRoaXMuZ2V0VGVtcGxhdGVQYXRoID0gdGhpcy5nZXRUZW1wbGF0ZVBhdGguYmluZCh0aGlzKTtcbiAgICB0aGlzLnRlbXBsYXRlRXhpc3RzID0gdGhpcy50ZW1wbGF0ZUV4aXN0cy5iaW5kKHRoaXMpO1xuICAgIHRoaXMuY2hlY2tBbmRSZW5kZXIgPSB0aGlzLmNoZWNrQW5kUmVuZGVyLmJpbmQodGhpcyk7XG4gICAgdGhpcy5yZW5kZXIgPSB0aGlzLnJlbmRlci5iaW5kKHRoaXMpO1xuICAgIHRoaXMucmVuZGVyQWxsID0gdGhpcy5yZW5kZXJBbGwuYmluZCh0aGlzKTtcbiAgICB0aGlzLnNlbmQgPSB0aGlzLnNlbmQuYmluZCh0aGlzKTtcbiAgfVxuXG4gIC8vIHNob3J0aGFuZCB1c2Ugb2YgYGp1aWNlUmVzb3VyY2VzYCB3aXRoIHRoZSBjb25maWdcbiAgLy8gKG1haW5seSBmb3IgY3VzdG9tIHJlbmRlcnMgbGlrZSBmcm9tIGEgZGF0YWJhc2UpXG4gIGp1aWNlUmVzb3VyY2VzKGh0bWwpIHtcbiAgICByZXR1cm4ganVpY2VSZXNvdXJjZXMoaHRtbCwgdGhpcy5jb25maWcuanVpY2VSZXNvdXJjZXMpO1xuICB9XG5cbiAgLy8gYSBzaW1wbGUgaGVscGVyIGZ1bmN0aW9uIHRoYXQgZ2V0cyB0aGUgYWN0dWFsIGZpbGUgcGF0aCBmb3IgdGhlIHRlbXBsYXRlXG4gIGFzeW5jIGdldFRlbXBsYXRlUGF0aCh0ZW1wbGF0ZSkge1xuICAgIGNvbnN0IFtyb290LCB2aWV3XSA9IHBhdGguaXNBYnNvbHV0ZSh0ZW1wbGF0ZSlcbiAgICAgID8gW3BhdGguZGlybmFtZSh0ZW1wbGF0ZSksIHBhdGguYmFzZW5hbWUodGVtcGxhdGUpXVxuICAgICAgOiBbdGhpcy5jb25maWcudmlld3Mucm9vdCwgdGVtcGxhdGVdO1xuICAgIGNvbnN0IHBhdGhzID0gYXdhaXQgZ2V0UGF0aHMoXG4gICAgICByb290LFxuICAgICAgdmlldyxcbiAgICAgIHRoaXMuY29uZmlnLnZpZXdzLm9wdGlvbnMuZXh0ZW5zaW9uXG4gICAgKTtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShyb290LCBwYXRocy5yZWwpO1xuICAgIHJldHVybiB7IGZpbGVQYXRoLCBwYXRocyB9O1xuICB9XG5cbiAgLy8gcmV0dXJucyB0cnVlIG9yIGZhbHNlIGlmIGEgdGVtcGxhdGUgZXhpc3RzXG4gIC8vICh1c2VzIHNhbWUgbG9vay11cCBhcHByb2FjaCBhcyBgcmVuZGVyYCBmdW5jdGlvbilcbiAgYXN5bmMgdGVtcGxhdGVFeGlzdHModmlldykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGZpbGVQYXRoIH0gPSBhd2FpdCB0aGlzLmdldFRlbXBsYXRlUGF0aCh2aWV3KTtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgc3RhdChmaWxlUGF0aCk7XG4gICAgICBpZiAoIXN0YXRzLmlzRmlsZSgpKSB0aHJvdyBuZXcgRXJyb3IoYCR7ZmlsZVBhdGh9IHdhcyBub3QgYSBmaWxlYCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGRlYnVnKCd0ZW1wbGF0ZUV4aXN0cycsIGVycik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2hlY2tBbmRSZW5kZXIodHlwZSwgdGVtcGxhdGUsIGxvY2Fscykge1xuICAgIGNvbnN0IHN0ciA9IGAke3RlbXBsYXRlfS8ke3R5cGV9YDtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmN1c3RvbVJlbmRlcikge1xuICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGhpcy50ZW1wbGF0ZUV4aXN0cyhzdHIpO1xuICAgICAgaWYgKCFleGlzdHMpIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5yZW5kZXIoc3RyLCB7XG4gICAgICAuLi5sb2NhbHMsXG4gICAgICAuLi4odHlwZSA9PT0gJ2h0bWwnID8ge30gOiB7IHByZXR0eTogZmFsc2UgfSlcbiAgICB9KTtcbiAgfVxuXG4gIC8vIHByb21pc2UgdmVyc2lvbiBvZiBjb25zb2xpZGF0ZSdzIHJlbmRlclxuICAvLyBpbnNwaXJlZCBieSBrb2Etdmlld3MgYW5kIHJlLXVzZXMgdGhlIHNhbWUgY29uZmlnXG4gIC8vIDxodHRwczovL2dpdGh1Yi5jb20vcXVlY2tlenova29hLXZpZXdzPlxuICBhc3luYyByZW5kZXIodmlldywgbG9jYWxzID0ge30pIHtcbiAgICBjb25zdCB7IG1hcCwgZW5naW5lU291cmNlIH0gPSB0aGlzLmNvbmZpZy52aWV3cy5vcHRpb25zO1xuICAgIGNvbnN0IHsgZmlsZVBhdGgsIHBhdGhzIH0gPSBhd2FpdCB0aGlzLmdldFRlbXBsYXRlUGF0aCh2aWV3KTtcbiAgICBpZiAocGF0aHMuZXh0ID09PSAnaHRtbCcgJiYgIW1hcCkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVhZEZpbGUoZmlsZVBhdGgsICd1dGY4Jyk7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIGNvbnN0IGVuZ2luZU5hbWUgPSBtYXAgJiYgbWFwW3BhdGhzLmV4dF0gPyBtYXBbcGF0aHMuZXh0XSA6IHBhdGhzLmV4dDtcbiAgICBjb25zdCByZW5kZXJGbiA9IGVuZ2luZVNvdXJjZVtlbmdpbmVOYW1lXTtcbiAgICBpZiAoIWVuZ2luZU5hbWUgfHwgIXJlbmRlckZuKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRW5naW5lIG5vdCBmb3VuZCBmb3IgdGhlIFwiLiR7cGF0aHMuZXh0fVwiIGZpbGUgZXh0ZW5zaW9uYFxuICAgICAgKTtcblxuICAgIGlmIChfLmlzT2JqZWN0KHRoaXMuY29uZmlnLmkxOG4pKSB7XG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMuY29uZmlnLmkxOG4ubGFzdExvY2FsZUZpZWxkICYmXG4gICAgICAgIHRoaXMuY29uZmlnLmxhc3RMb2NhbGVGaWVsZCAmJlxuICAgICAgICB0aGlzLmNvbmZpZy5pMThuLmxhc3RMb2NhbGVGaWVsZCAhPT0gdGhpcy5jb25maWcubGFzdExvY2FsZUZpZWxkXG4gICAgICApXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgVGhlICdsYXN0TG9jYWxlRmllbGQnIChTdHJpbmcpIG9wdGlvbiBmb3IgQGxhZGpzL2kxOG4gYW5kIGVtYWlsLXRlbXBsYXRlcyBkbyBub3QgbWF0Y2gsIGkxOG4gdmFsdWUgd2FzICR7dGhpcy5jb25maWcuaTE4bi5sYXN0TG9jYWxlRmllbGR9IGFuZCBlbWFpbC10ZW1wbGF0ZXMgdmFsdWUgd2FzICR7dGhpcy5jb25maWcubGFzdExvY2FsZUZpZWxkfWBcbiAgICAgICAgKTtcblxuICAgICAgY29uc3QgaTE4biA9IG5ldyBJMThOKHsgLi4udGhpcy5jb25maWcuaTE4biwgcmVnaXN0ZXI6IGxvY2FscyB9KTtcblxuICAgICAgLy8gc3VwcG9ydCBgbG9jYWxzLnVzZXIubGFzdF9sb2NhbGVgICh2YXJpYWJsZSBiYXNlZCBuYW1lIGxhc3RMb2NhbGVGaWVsZClcbiAgICAgIC8vIChlLmcuIGZvciA8aHR0cHM6Ly9sYWQuanMub3JnPilcbiAgICAgIGlmIChcbiAgICAgICAgXy5pc09iamVjdChsb2NhbHMudXNlcikgJiZcbiAgICAgICAgXy5pc1N0cmluZyhsb2NhbHMudXNlclt0aGlzLmNvbmZpZy5sYXN0TG9jYWxlRmllbGRdKVxuICAgICAgKVxuICAgICAgICBsb2NhbHMubG9jYWxlID0gbG9jYWxzLnVzZXJbdGhpcy5jb25maWcubGFzdExvY2FsZUZpZWxkXTtcblxuICAgICAgaWYgKF8uaXNTdHJpbmcobG9jYWxzLmxvY2FsZSkpIGkxOG4uc2V0TG9jYWxlKGxvY2Fscy5sb2NhbGUpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHBpZnkocmVuZGVyRm4pKGZpbGVQYXRoLCBsb2NhbHMpO1xuICAgIC8vIHRyYW5zZm9ybSB0aGUgaHRtbCB3aXRoIGp1aWNlIHVzaW5nIHJlbW90ZSBwYXRoc1xuICAgIC8vIGdvb2dsZSBub3cgc3VwcG9ydHMgbWVkaWEgcXVlcmllc1xuICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2dtYWlsL2Rlc2lnbi9yZWZlcmVuY2Uvc3VwcG9ydGVkX2Nzc1xuICAgIGlmICghdGhpcy5jb25maWcuanVpY2UpIHJldHVybiByZXM7XG4gICAgY29uc3QgaHRtbCA9IGF3YWl0IHRoaXMuanVpY2VSZXNvdXJjZXMocmVzKTtcbiAgICByZXR1cm4gaHRtbDtcbiAgfVxuXG4gIGFzeW5jIHJlbmRlckFsbCh0ZW1wbGF0ZSwgbG9jYWxzID0ge30sIG5vZGVtYWlsZXJNZXNzYWdlID0ge30pIHtcbiAgICBjb25zdCBtZXNzYWdlID0geyAuLi5ub2RlbWFpbGVyTWVzc2FnZSB9O1xuXG4gICAgaWYgKHRlbXBsYXRlKSB7XG4gICAgICBjb25zdCBbc3ViamVjdCwgaHRtbCwgdGV4dF0gPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgWydzdWJqZWN0JywgJ2h0bWwnLCAndGV4dCddLm1hcCh0eXBlID0+XG4gICAgICAgICAgdGhpcy5jaGVja0FuZFJlbmRlcih0eXBlLCB0ZW1wbGF0ZSwgbG9jYWxzKVxuICAgICAgICApXG4gICAgICApO1xuXG4gICAgICBpZiAoc3ViamVjdCkgbWVzc2FnZS5zdWJqZWN0ID0gc3ViamVjdC50cmltKCk7XG4gICAgICBpZiAoaHRtbCkgbWVzc2FnZS5odG1sID0gaHRtbDtcbiAgICAgIGlmICh0ZXh0KSBtZXNzYWdlLnRleHQgPSB0ZXh0O1xuICAgIH1cblxuICAgIGlmIChtZXNzYWdlLnN1YmplY3QgJiYgdGhpcy5jb25maWcuc3ViamVjdFByZWZpeClcbiAgICAgIG1lc3NhZ2Uuc3ViamVjdCA9IHRoaXMuY29uZmlnLnN1YmplY3RQcmVmaXggKyBtZXNzYWdlLnN1YmplY3Q7XG5cbiAgICBpZiAodGhpcy5jb25maWcuaHRtbFRvVGV4dCAmJiBtZXNzYWdlLmh0bWwgJiYgIW1lc3NhZ2UudGV4dClcbiAgICAgIC8vIHdlJ2QgdXNlIG5vZGVtYWlsZXItaHRtbC10by10ZXh0IHBsdWdpblxuICAgICAgLy8gYnV0IHdlIHJlYWxseSBkb24ndCBuZWVkIHRvIHN1cHBvcnQgY2lkXG4gICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL2FuZHJpczkvbm9kZW1haWxlci1odG1sLXRvLXRleHQ+XG4gICAgICBtZXNzYWdlLnRleHQgPSBodG1sVG9UZXh0LmZyb21TdHJpbmcoXG4gICAgICAgIG1lc3NhZ2UuaHRtbCxcbiAgICAgICAgdGhpcy5jb25maWcuaHRtbFRvVGV4dFxuICAgICAgKTtcblxuICAgIC8vIGlmIHdlIG9ubHkgd2FudCBhIHRleHQtYmFzZWQgdmVyc2lvbiBvZiB0aGUgZW1haWxcbiAgICBpZiAodGhpcy5jb25maWcudGV4dE9ubHkpIGRlbGV0ZSBtZXNzYWdlLmh0bWw7XG5cbiAgICAvLyBpZiBubyBzdWJqZWN0LCBodG1sLCBvciB0ZXh0IGNvbnRlbnQgZXhpc3RzIHRoZW4gd2Ugc2hvdWxkXG4gICAgLy8gdGhyb3cgYW4gZXJyb3IgdGhhdCBzYXlzIGF0IGxlYXN0IG9uZSBtdXN0IGJlIGZvdW5kXG4gICAgLy8gb3RoZXJ3aXNlIHRoZSBlbWFpbCB3b3VsZCBiZSBibGFuayAoZGVmZWF0cyBwdXJwb3NlIG9mIGVtYWlsLXRlbXBsYXRlcylcbiAgICBpZiAoXG4gICAgICAoIWlzLnN0cmluZyhtZXNzYWdlLnN1YmplY3QpIHx8XG4gICAgICAgIGlzLmVtcHR5U3RyaW5nT3JXaGl0ZXNwYWNlKG1lc3NhZ2Uuc3ViamVjdCkpICYmXG4gICAgICAoIWlzLnN0cmluZyhtZXNzYWdlLnRleHQpIHx8IGlzLmVtcHR5U3RyaW5nT3JXaGl0ZXNwYWNlKG1lc3NhZ2UudGV4dCkpICYmXG4gICAgICAoIWlzLnN0cmluZyhtZXNzYWdlLmh0bWwpIHx8IGlzLmVtcHR5U3RyaW5nT3JXaGl0ZXNwYWNlKG1lc3NhZ2UuaHRtbCkpICYmXG4gICAgICBfLmlzQXJyYXkobWVzc2FnZS5hdHRhY2htZW50cykgJiZcbiAgICAgIF8uaXNFbXB0eShtZXNzYWdlLmF0dGFjaG1lbnRzKVxuICAgIClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE5vIGNvbnRlbnQgd2FzIHBhc3NlZCBmb3Igc3ViamVjdCwgaHRtbCwgdGV4dCwgbm9yIGF0dGFjaG1lbnRzIG1lc3NhZ2UgcHJvcHMuIENoZWNrIHRoYXQgdGhlIGZpbGVzIGZvciB0aGUgdGVtcGxhdGUgXCIke3RlbXBsYXRlfVwiIGV4aXN0LmBcbiAgICAgICk7XG5cbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIGFzeW5jIHNlbmQob3B0aW9ucyA9IHt9KSB7XG4gICAgb3B0aW9ucyA9IHtcbiAgICAgIHRlbXBsYXRlOiAnJyxcbiAgICAgIG1lc3NhZ2U6IHt9LFxuICAgICAgbG9jYWxzOiB7fSxcbiAgICAgIC4uLm9wdGlvbnNcbiAgICB9O1xuXG4gICAgbGV0IHsgdGVtcGxhdGUsIG1lc3NhZ2UsIGxvY2FscyB9ID0gb3B0aW9ucztcblxuICAgIGNvbnN0IGF0dGFjaG1lbnRzID1cbiAgICAgIG1lc3NhZ2UuYXR0YWNobWVudHMgfHwgdGhpcy5jb25maWcubWVzc2FnZS5hdHRhY2htZW50cyB8fCBbXTtcblxuICAgIG1lc3NhZ2UgPSBfLmRlZmF1bHRzRGVlcChcbiAgICAgIHt9LFxuICAgICAgXy5vbWl0KG1lc3NhZ2UsICdhdHRhY2htZW50cycpLFxuICAgICAgXy5vbWl0KHRoaXMuY29uZmlnLm1lc3NhZ2UsICdhdHRhY2htZW50cycpXG4gICAgKTtcbiAgICBsb2NhbHMgPSBfLmRlZmF1bHRzRGVlcCh7fSwgdGhpcy5jb25maWcudmlld3MubG9jYWxzLCBsb2NhbHMpO1xuXG4gICAgaWYgKGF0dGFjaG1lbnRzKSBtZXNzYWdlLmF0dGFjaG1lbnRzID0gYXR0YWNobWVudHM7XG5cbiAgICBkZWJ1ZygndGVtcGxhdGUgJXMnLCB0ZW1wbGF0ZSk7XG4gICAgZGVidWcoJ21lc3NhZ2UgJU8nLCBtZXNzYWdlKTtcbiAgICBkZWJ1ZygnbG9jYWxzIChrZXlzIG9ubHkpOiAlTycsIE9iamVjdC5rZXlzKGxvY2FscykpO1xuXG4gICAgLy8gZ2V0IGFsbCBhdmFpbGFibGUgdGVtcGxhdGVzXG4gICAgY29uc3Qgb2JqID0gYXdhaXQgdGhpcy5yZW5kZXJBbGwodGVtcGxhdGUsIGxvY2FscywgbWVzc2FnZSk7XG5cbiAgICAvLyBhc3NpZ24gdGhlIG9iamVjdCB2YXJpYWJsZXMgb3ZlciB0byB0aGUgbWVzc2FnZVxuICAgIE9iamVjdC5hc3NpZ24obWVzc2FnZSwgb2JqKTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5wcmV2aWV3KSB7XG4gICAgICBkZWJ1ZygndXNpbmcgYHByZXZpZXctZW1haWxgIHRvIHByZXZpZXcgZW1haWwnKTtcbiAgICAgIGlmIChfLmlzT2JqZWN0KHRoaXMuY29uZmlnLnByZXZpZXcpKVxuICAgICAgICBhd2FpdCBwcmV2aWV3RW1haWwobWVzc2FnZSwgdGhpcy5jb25maWcucHJldmlldyk7XG4gICAgICBlbHNlIGF3YWl0IHByZXZpZXdFbWFpbChtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY29uZmlnLnNlbmQpIHtcbiAgICAgIGRlYnVnKCdzZW5kIGRpc2FibGVkIHNvIHdlIGFyZSBlbnN1cmluZyBKU09OVHJhbnNwb3J0Jyk7XG4gICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL25vZGVtYWlsZXIvbm9kZW1haWxlci9pc3N1ZXMvNzk4PlxuICAgICAgLy8gaWYgKHRoaXMuY29uZmlnLnRyYW5zcG9ydC5uYW1lICE9PSAnSlNPTlRyYW5zcG9ydCcpXG4gICAgICB0aGlzLmNvbmZpZy50cmFuc3BvcnQgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7XG4gICAgICAgIGpzb25UcmFuc3BvcnQ6IHRydWVcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY29uZmlnLnRyYW5zcG9ydC5zZW5kTWFpbChtZXNzYWdlKTtcbiAgICBkZWJ1ZygnbWVzc2FnZSBzZW50Jyk7XG4gICAgcmVzLm9yaWdpbmFsTWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgcmV0dXJuIHJlcztcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEVtYWlsO1xuIl19